top_builddir=../../../..
include $(top_builddir)/Makefile.conf

GENSRC = bios_symbols.c
XSFILES = bios.s
BIOS_START = 0xe000
ALL_CPPFLAGS += -DBIOS_START=$(BIOS_START)

all: lib
# unused target, for testing
everyth: lib bios_offsets.hh bios_data.xxd

include $(REALTOPDIR)/src/Makefile.common

# to support parallel build, we need a separate .o and .elf for every gen target
bios0.o bios1.o bios2.o: $(srcdir)/bios.s $(srcdir)/Makefile $(top_builddir)/src/include/version.hh
	$(CPP) $(ALL_CPPFLAGS) -x assembler-with-cpp $< | $(AS) --32 -o $@

.INTERMEDIATE: bios_data bios0.elf bios1.elf bios2.elf bios0.o bios1.o bios2.o

bios_data: bios0.elf
	$(OBJCOPY) -j .text -O binary $< $@

# Makefile defines BIOS_START so add to deps
bios%.elf: bios%.o $(srcdir)/Makefile
	# formal intermediate filename is necessary for xxd to name structure
	$(AS_LD) $(AS_LDFLAGS) -static --section-start .text=$(BIOS_START) -e bios_data_start -Map bios.map -o $@ $<
	chmod -x $@

bios_data.xxd: bios_data
	echo "const char *bios_data = \"\\" >$@
	hexdump -v -e '"\\" "x" 1/1 "%02X"' $< >>$@
	echo "\";" >>$@

bios_symbols.c: bios1.elf
	nm -g -n $< | gawk '\
		BEGIN {\
		  COUNT=0;\
		  print "// Warning: autogenerated";\
	          print "";\
	          print "#include \"bios_sym.h\"";\
	          print "";\
		  print "struct bios_symbol_entry bios_symbol[] = {";\
		}\
		{\
		  HEXSTR = sprintf("0x%s", $$1);\
		  ADDR = strtonum(HEXSTR);\
		  if (ADDR <= 0xffff) {\
		    COUNT++;\
		    printf "  { 0x%04x, \"%s\" },\n", ADDR, $$3;\
		  }\
		}\
		END {\
		  print "};";\
		  print "";\
	          print "int bios_symbol_num = " COUNT ";";\
		}\
		' > $@ || (rm -f $@ ; false)

bios_offsets.hh: bios2.elf
	nm -g -n $< | gawk '\
		BEGIN {\
		  print "// Warning: autogenerated";\
	          print "";\
		}\
		{\
		  HEXSTR = sprintf("0x%s", $$1);\
		  ADDR = strtonum(HEXSTR);\
		  if (ADDR <= 0xffff) {\
		    printf "#define %s 0x%04x\n", $$3, ADDR;\
		  }\
		}\
		END {\
		  print "";\
		}\
		' > $@ || (rm -f $@ ; false)

clean::
	rm -f *.o *.d bios_symbols.c bios_offsets.hh bios_data.xxd bios_data bios*.elf bios.map
